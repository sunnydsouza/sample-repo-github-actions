name: Java Semantic Release Example

on:
  push:
    branches:
      - main

env:
  GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
#  NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
#  NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
  OSSRH_USERNAME: ${{ secrets.NEXUS_USERNAME }}
  OSSRH_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

jobs:
  build-semantic-release:
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Install Java and Maven
        uses: actions/setup-java@v2
        with:
          java-version: "15"
          distribution: "adopt"

      - name: Restore local Maven repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ github.sha }}

      - name: Setup Node.js and semantic-release plugins
        uses: actions/setup-node@v1
        with:
          node-version: 16
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
      - run: npm install -g semantic-release @semantic-release/changelog @semantic-release/commit-analyzer @semantic-release/exec semantic-release/git semantic-release/release-notes-generator
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: chmod +x ./prepare-release.sh && npx semantic-release
  github-publish:
    needs:
      - build-semantic-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'temurin'
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Build with Maven
        run: mvn -B package --file pom.xml

      - name: Publish to GitHub Packages Apache Maven
        run: mvn deploy:deploy-file -DrepositoryId=github -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
  maven-publish:
    runs-on: ubuntu-latest
    needs:
      - build-semantic-release
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Install Java and Maven
        uses: actions/setup-java@v1
        with:
          java-version: '11'
          distribution: 'temurin'
          server-id: ossrh # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Release Maven package
        uses: samuelmeuli/action-maven-publish@v1
        with:
          gpg_private_key: ${{ env.GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ env.GPG_PASSPHRASE }}
          nexus_username: ${{ env.OSSRH_USERNAME }}
          nexus_password: ${{ env.OSSRH_PASSWORD }}

#      - name: Build with Maven
#        run: mvn -B package --file pom.xml
#
#      - name: Publish to GitHub Packages Apache Maven
#        run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
#        env:
#          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
#          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
#          OSSRH_TOKEN: ${{ secrets.OSSRH_TOKEN }}
#          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
##          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
##          gpg_private_key: ${{ env.GPG_PRIVATE_KEY }}
##          gpg_passphrase: ${{ env.GPG_PASSPHRASE }}
##          nexus_username: ${{ env.NEXUS_USERNAME }}
##          nexus_password: ${{ env.NEXUS_PASSWORD }}

#  publish:
#    runs-on: ubuntu-latest
#    needs:
#      - build-semantic-release
#    permissions:
#      contents: read
#      packages: write
#    steps:
#      - uses: actions/checkout@v2
##      - name: Set up Java for publishing to GitHub Packages
##        uses: actions/setup-java@v2
##        with:
##          java-version: '11'
##          distribution: 'temurin'
#           server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
#           settings-path: ${{ github.workspace }} # location for the settings.xml file
##      - name: Publish to GitHub Packages
##        run: mvn --batch-mode deploy -s $GITHUB_WORKSPACE/settings.xml
##        env:
##          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      - name: Set up Java for publishing to Maven Central Repository
#        uses: actions/setup-java@v2
#        with:
#          java-version: '11'
#          distribution: 'temurin'
#          server-id: ossrh
#          server-username: MAVEN_USERNAME
#          server-password: MAVEN_PASSWORD
#          gpg-private-key: ${{ env.GPG_PRIVATE_KEY }} # Value of the GPG private key to import
#          gpg-passphrase: MAVEN_GPG_PASSPHRASE #
#      - name: Publish to the Maven Central Repository
#        run: mvn --batch-mode deploy -s $GITHUB_WORKSPACE/settings.xml
#        env:
#          MAVEN_USERNAME: ${{ env.OSSRH_USERNAME }}
#          MAVEN_PASSWORD: ${{ env.OSSRH_PASSWORD }}
#          MAVEN_GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}